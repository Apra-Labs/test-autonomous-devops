name: Test Multi-Flavor Coordination

on:
  workflow_dispatch:  # Manual trigger only

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # Simulate 7 parallel flavors like ApraPipes
  flavor-linux-x64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: pip install anthropic PyGithub gitpython pyyaml
      - name: Run agent (flavor: linux-x64)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python agent/autonomous_agent.py \
            --branch main \
            --build-status failure \
            --failure-log test-project/error.log \
            --mock \
            --output result-linux-x64.json
      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: result-linux-x64
          path: result-linux-x64.json

  flavor-linux-arm64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: pip install anthropic PyGithub gitpython pyyaml
      - name: Run agent (flavor: linux-arm64)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python agent/autonomous_agent.py \
            --branch main \
            --build-status failure \
            --failure-log test-project/error.log \
            --mock \
            --output result-linux-arm64.json
      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: result-linux-arm64
          path: result-linux-arm64.json

  flavor-windows:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: pip install anthropic PyGithub gitpython pyyaml
      - name: Run agent (flavor: windows)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python agent/autonomous_agent.py \
            --branch main \
            --build-status failure \
            --failure-log test-project/error.log \
            --mock \
            --output result-windows.json
      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: result-windows
          path: result-windows.json

  # Verification job - check coordination worked
  verify-coordination:
    needs: [flavor-linux-x64, flavor-linux-arm64, flavor-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: results
      - name: Verify only one flavor investigated
        run: |
          echo "Checking coordination results..."

          # Count how many flavors did investigation vs coordination_skip
          investigated=0
          skipped=0

          for result in results/*/result-*.json; do
            action=$(cat $result | python -c "import sys, json; print(json.load(sys.stdin)['action_taken'])")
            echo "$(basename $result): $action"

            if [ "$action" = "coordination_skip" ]; then
              skipped=$((skipped + 1))
            elif [ "$action" = "first_failure" ]; then
              investigated=$((investigated + 1))
            fi
          done

          echo ""
          echo "Results:"
          echo "  Investigated: $investigated"
          echo "  Skipped: $skipped"
          echo ""

          # Expect exactly 1 investigated, rest skipped
          if [ $investigated -eq 1 ]; then
            echo "✅ SUCCESS: Exactly one flavor investigated (saved LLM costs)"
          else
            echo "❌ FAIL: Expected 1 flavor to investigate, got $investigated"
            exit 1
          fi

          if [ $skipped -eq 2 ]; then
            echo "✅ SUCCESS: Two flavors skipped via coordination"
          else
            echo "❌ FAIL: Expected 2 flavors to skip, got $skipped"
            exit 1
          fi
