name: Test and Auto-Fix

on:
  push:
    branches: ['**']  # Trigger on ALL branches
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          cd test-project
          pip install -r requirements.txt || true

      - name: Run tests
        id: test
        run: |
          cd test-project
          python test_main.py > ../test-output.log 2>&1
        continue-on-error: true

      - name: Check test result
        run: |
          if [ ${{ steps.test.outcome }} == 'success' ]; then
            echo "Tests passed"
          else
            echo "Tests failed"
            cat test-output.log
          fi

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: test-output.log

  autonomous-fix:
    needs: build-test
    if: always()  # ALWAYS run, even if build passes
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      # CASE 4 optimization: Quick check before checkout
      - name: Pre-check (CASE 4 early exit)
        id: precheck
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          BUILD_STATUS="${{ needs.build-test.result }}"

          echo "Branch: $BRANCH"
          echo "Build status: $BUILD_STATUS"

          # CASE 4: Success on non-fix branch = do nothing
          if [[ ! "$BRANCH" =~ ^autonomous-fix- ]] && [[ "$BUILD_STATUS" == "success" ]]; then
            echo "CASE 4: Build passed on non-fix branch - nothing to do"
            echo "action=skip" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Need to run agent"
          echo "action=run" >> $GITHUB_OUTPUT

      - name: Checkout code
        if: steps.precheck.outputs.action == 'run'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to detect attempts
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        if: steps.precheck.outputs.action == 'run'
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install agent dependencies
        if: steps.precheck.outputs.action == 'run'
        run: pip install anthropic PyGithub gitpython pyyaml

      - name: Download test logs
        if: steps.precheck.outputs.action == 'run' && needs.build-test.result == 'failure'
        uses: actions/download-artifact@v4
        with:
          name: test-logs
          path: .

      - name: Configure git
        if: steps.precheck.outputs.action == 'run'
        run: |
          git config user.name "Autonomous Agent"
          git config user.email "autonomous-agent@apra.ai"

      - name: Run autonomous agent
        if: steps.precheck.outputs.action == 'run'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          BUILD_STATUS="${{ needs.build-test.result }}"

          # Prepare failure log argument
          FAILURE_LOG_ARG=""
          if [ -f "test-output.log" ]; then
            FAILURE_LOG_ARG="--failure-log test-output.log"
          fi

          echo "=== Running Autonomous Agent ==="
          echo "Branch: $BRANCH"
          echo "Build Status: $BUILD_STATUS"

          python agent/autonomous_agent.py \
            --branch "$BRANCH" \
            --build-status "$BUILD_STATUS" \
            $FAILURE_LOG_ARG \
            --output agent-result.json

      - name: Upload agent result
        if: always() && steps.precheck.outputs.action == 'run'
        uses: actions/upload-artifact@v4
        with:
          name: agent-result
          path: agent-result.json

      - name: Display result
        if: always() && steps.precheck.outputs.action == 'run'
        run: |
          if [ -f agent-result.json ]; then
            echo "=== Agent Result ==="
            cat agent-result.json | python -m json.tool || cat agent-result.json
          fi
