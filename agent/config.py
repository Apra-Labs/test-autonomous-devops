"""
Autonomous DevOps Agent Configuration

All configurable parameters in one place for easy reuse across projects.
"""
from dataclasses import dataclass
from typing import Dict, Optional

@dataclass
class ModelConfig:
    """LLM model configuration"""
    # Model names
    SONNET_MODEL = "claude-sonnet-4-5-20250929"
    OPUS_MODEL = "claude-opus-4-5-20250820"

    # Attempt thresholds for model switching
    SONNET_MAX_ATTEMPTS = 4  # Use Sonnet for attempts 1-4
    OPUS_MAX_ATTEMPTS = 6    # Use Opus for attempts 5-6
    ESCALATION_THRESHOLD = 7  # Escalate to human after attempt 6

    # Model parameters
    MAX_TOKENS = 8192
    TEMPERATURE = 0.0  # Deterministic for consistency

    # Iterative investigation parameters
    MAX_INVESTIGATION_TURNS = 5  # Max back-and-forth turns for context building
    MAX_TOKENS_PER_TURN = 10000  # Max tokens per LLM response
    MAX_TOTAL_TOKENS = 50000  # Max tokens across all turns (~$0.50 on Sonnet)
    MIN_FIX_CONFIDENCE = 0.85  # Minimum confidence to apply fix
    MAX_FILE_SIZE_BYTES = 100000  # Don't send files > 100KB
    MAX_LOG_EXCERPT_LINES = 2000  # Max lines per log excerpt
    COST_PER_INPUT_TOKEN = 0.000003  # Sonnet input cost
    MAX_COST_PER_ATTEMPT = 0.50  # Max $0.50 per fix attempt

    def get_model_for_attempt(self, attempt: int) -> str:
        """
        Get appropriate model based on attempt number

        Args:
            attempt: Current attempt number (1-indexed)

        Returns:
            Model name to use
        """
        if attempt <= self.SONNET_MAX_ATTEMPTS:
            return self.SONNET_MODEL
        elif attempt <= self.OPUS_MAX_ATTEMPTS:
            return self.OPUS_MODEL
        else:
            raise ValueError(f"Attempt {attempt} exceeds max attempts {self.OPUS_MAX_ATTEMPTS}")

    def should_escalate(self, attempt: int) -> bool:
        """
        Check if we should escalate to human

        Args:
            attempt: Current attempt number (1-indexed)

        Returns:
            True if should escalate to human
        """
        return attempt >= self.ESCALATION_THRESHOLD


@dataclass
class GitConfig:
    """Git and GitHub configuration"""
    # Branch naming
    BRANCH_PREFIX = "autonomous-fix"
    BRANCH_FORMAT = "{prefix}-{fix_id}"  # No /attempt-N in branch name

    # Labels
    LABEL_PREFIX = "autonomous-fix"
    LABEL_ATTEMPT_FORMAT = "{prefix}-{fix_id}-attempt-{attempt}"
    LABEL_ESCALATION_FORMAT = "{prefix}-{fix_id}-escalation"
    LABEL_PLATFORM_FORMAT = "platform-{platform}"
    LABEL_HIGH_CONFIDENCE = "high-confidence"
    LABEL_NEEDS_HUMAN = "needs-human-attention"

    # PR configuration
    PR_TITLE_FORMAT = "ðŸ¤– Auto-Fix: {description}"
    PR_BODY_TEMPLATE = """## ðŸ¤– Autonomous DevOps Agent

**Fix ID:** {fix_id}
**Attempt:** {attempt} of {max_attempts}
**Model Used:** {model}
**Confidence:** {confidence:.2f}

{previous_attempts_section}

## ðŸ” Root Cause

{root_cause}

## ðŸ”§ Fix Applied

{fix_description}

**Reasoning:**
{reasoning}

## ðŸ“š Skill Updates

{skill_updates_section}

## ðŸ“ Files Changed

{files_changed}

---
Generated by Autonomous DevOps Agent
Run: {run_id}
"""

    def format_branch_name(self, fix_id: str) -> str:
        """Format branch name (no attempt number)"""
        return self.BRANCH_FORMAT.format(
            prefix=self.BRANCH_PREFIX,
            fix_id=fix_id
        )

    def format_attempt_label(self, fix_id: str, attempt: int) -> str:
        """Format label for specific attempt"""
        return self.LABEL_ATTEMPT_FORMAT.format(
            prefix=self.LABEL_PREFIX,
            fix_id=fix_id,
            attempt=attempt
        )

    def format_escalation_label(self, fix_id: str) -> str:
        """Format escalation label"""
        return self.LABEL_ESCALATION_FORMAT.format(
            prefix=self.LABEL_PREFIX,
            fix_id=fix_id
        )

    def format_labels(self, fix_id: str, attempt: int, platform: str,
                     high_confidence: bool = False) -> list[str]:
        """Format PR/issue labels"""
        labels = [
            f"{self.LABEL_PREFIX}-{fix_id}",
            self.LABEL_ATTEMPT_FORMAT.format(attempt=attempt),
            self.LABEL_PLATFORM_FORMAT.format(platform=platform)
        ]

        if high_confidence:
            labels.append(self.LABEL_HIGH_CONFIDENCE)

        return labels


@dataclass
class SkillConfig:
    """Skill knowledge configuration"""
    # Skill file paths (relative to skills directory)
    MAIN_SKILL = "SKILL.md"
    TROUBLESHOOTING_TEMPLATE = "troubleshooting.{platform}.md"

    # Pattern confidence thresholds
    HIGH_CONFIDENCE_THRESHOLD = 0.85
    MEDIUM_CONFIDENCE_THRESHOLD = 0.60
    LOW_CONFIDENCE_THRESHOLD = 0.0

    # Skill update settings
    AUTO_UPDATE_SKILL = True
    INCLUDE_SKILL_IN_PR = True

    def get_confidence_level(self, confidence: float) -> str:
        """Get confidence level label"""
        if confidence >= self.HIGH_CONFIDENCE_THRESHOLD:
            return "HIGH"
        elif confidence >= self.MEDIUM_CONFIDENCE_THRESHOLD:
            return "MEDIUM"
        else:
            return "LOW"


@dataclass
class AgentConfig:
    """Main agent configuration"""
    model: ModelConfig
    git: GitConfig
    skill: SkillConfig

    # Agent behavior
    ENABLE_AUTO_FIX = True
    ENABLE_PR_CREATION = True
    ENABLE_SKILL_UPDATES = True

    # Multi-flavor coordination (cost optimization)
    ENABLE_FLAVOR_COORDINATION = True  # Avoid duplicate LLM analysis across flavors
    MAX_COORDINATION_WAIT_MINUTES = 15  # Max time to wait for another flavor's fix

    # Logging
    VERBOSE = True
    LOG_FILE = "agent.log"

    @classmethod
    def default(cls) -> 'AgentConfig':
        """Create default configuration"""
        return cls(
            model=ModelConfig(),
            git=GitConfig(),
            skill=SkillConfig()
        )

    def to_dict(self) -> Dict:
        """Convert to dictionary for serialization"""
        return {
            'model': {
                'sonnet_model': self.model.SONNET_MODEL,
                'opus_model': self.model.OPUS_MODEL,
                'sonnet_max_attempts': self.model.SONNET_MAX_ATTEMPTS,
                'opus_max_attempts': self.model.OPUS_MAX_ATTEMPTS,
                'escalation_threshold': self.model.ESCALATION_THRESHOLD
            },
            'git': {
                'branch_prefix': self.git.BRANCH_PREFIX,
                'label_prefix': self.git.LABEL_PREFIX
            },
            'skill': {
                'high_confidence_threshold': self.skill.HIGH_CONFIDENCE_THRESHOLD,
                'medium_confidence_threshold': self.skill.MEDIUM_CONFIDENCE_THRESHOLD,
                'auto_update_skill': self.skill.AUTO_UPDATE_SKILL
            },
            'agent': {
                'enable_auto_fix': self.ENABLE_AUTO_FIX,
                'enable_pr_creation': self.ENABLE_PR_CREATION,
                'enable_skill_updates': self.ENABLE_SKILL_UPDATES
            }
        }


# Global default configuration instance
DEFAULT_CONFIG = AgentConfig.default()
